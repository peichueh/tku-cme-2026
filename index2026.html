<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 淡江化材研討會評分系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .canvas-container { border: 2px dashed #ccc; background: #f9f9f9; }
        canvas { width: 100%; height: 200px; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <nav class="bg-blue-900 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">2026 淡江化材研討會 (2026/01/13)</h1>
            <div id="userInfo" class="text-sm">尚未登入</div>
        </div>
    </nav>

    <main class="container mx-auto p-4">
        <section id="loginSection" class="max-w-md mx-auto bg-white p-8 mt-10 rounded-xl shadow-md">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-700">評審登入</h2>
            <div class="space-y-4">
                <input type="text" id="judgeName" placeholder="評審姓名" class="w-full p-3 border rounded">
                <select id="judgeVenue" class="w-full p-3 border rounded">
                    <option value="">請選擇所屬場地</option>
                    <option value="A1">A1 場地</option>
                    <option value="A2">A2 場地</option>
                    <option value="B1">B1 場地</option>
                    <option value="B2">B2 場地</option>
                </select>
                <input type="password" id="judgePwd" placeholder="密碼" class="w-full p-3 border rounded">
                <button onclick="login()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">登入系統代入</button>
            </div>
        </section>

        <section id="listSection" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 id="venueTitle" class="text-2xl font-bold text-gray-800">場地學生名單</h2>
                <button onclick="showAdmin()" class="text-blue-600 underline">助理管理後台</button>
            </div>
            <div id="studentCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                </div>
        </section>

        <section id="scoreSection" class="hidden max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-md">
            <button onclick="backToList()" class="mb-4 text-blue-500">← 返回名單</button>
            <h2 id="scoringStudent" class="text-2xl font-bold mb-6 text-blue-900">正在評分：張同學</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-4 border-r pr-4">
                    <h3 class="font-bold text-lg border-b pb-2 text-red-700">專業性評分 (70%)</h3>
                    <label class="block">專業性原始得分 (0-100):
                        <input type="number" id="profRaw" class="w-full p-2 border rounded" min="0" max="100">
                    </label>
                    <div class="space-y-2 text-sm italic text-gray-600">
                        * A.報告內容 (1-5) * A.流暢度 (1-5) * A.提問詮釋 (1-5)
                    </div>
                </div>

                <div class="space-y-4">
                    <h3 class="font-bold text-lg border-b pb-2 text-green-700">技術性評分 (30%)</h3>
                    <label class="block">技術性原始得分 (0-100):
                        <input type="number" id="techRaw" class="w-full p-2 border rounded" min="0" max="100">
                    </label>
                    <div class="space-y-2 text-sm italic text-gray-600">
                        * B.時間控制 (1-5) * B.服裝儀容 (1-5)
                    </div>
                </div>
            </div>

            <div class="mt-8">
                <label class="block font-bold mb-2">委員意見 (長文字):</label>
                <textarea id="judgeComment" class="w-full p-3 border rounded h-32" placeholder="請輸入評語..."></textarea>
            </div>

            <div class="mt-8">
                <label class="block font-bold mb-2">評審無紙化簽章:</label>
                <div class="canvas-container">
                    <canvas id="signature-pad"></canvas>
                </div>
                <button onclick="clearSignature()" class="mt-2 text-sm text-red-500 underline">清除簽名</button>
            </div>

            <div class="mt-10 flex justify-between items-center bg-gray-100 p-6 rounded-lg">
                <div class="text-xl font-bold">
                    加權總分：<span id="liveTotal" class="text-blue-700 text-3xl">0</span>
                </div>
                <button onclick="submitScore()" class="bg-blue-900 text-white px-10 py-3 rounded-xl hover:bg-black transition">送出評分</button>
            </div>
        </section>

        <section id="adminSection" class="hidden">
            <h2 class="text-2xl font-bold mb-6">助理監控中心</h2>
            <div class="flex gap-4 mb-6">
                <button onclick="exportExcel()" class="bg-green-600 text-white px-4 py-2 rounded">匯出完整總表 (Excel)</button>
                <button onclick="clearAllData()" class="bg-red-600 text-white px-4 py-2 rounded">清空資料庫</button>
                <button onclick="backToList()" class="bg-gray-500 text-white px-4 py-2 rounded">返回</button>
            </div>
            <div class="bg-white p-4 rounded shadow">
                <h3 class="font-bold mb-4">即時排行榜 (Top 3)</h3>
                <div id="leaderboard" class="space-y-2">
                    </div>
            </div>
        </section>
    </main>

    <script>

// Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

        // --- 1. Firebase 初始化 (請填寫您的 Config) ---
        const firebaseConfig = {
              apiKey: "AIzaSyBNa3SAk7yqzRjPyYuKZyLIJesm6M7c57w",
              authDomain: "cme-seminar2026.firebaseapp.com",
              projectId: "cme-seminar2026",
              storageBucket: "cme-seminar2026.firebasestorage.app",
              messagingSenderId: "61658181836",
              appId: "1:61658181836:web:6c8d964c66512575dc9269"
        };
        // firebase.initializeApp(firebaseConfig);
        // const db = firebase.firestore();

        // 模擬資料 (實際開發時會從 Firebase 讀取)
        let students = [
            { id: "S01", name: "王大明", title: "先進材料研究", advisor: "李教授", venue: "A1" },
            { id: "S02", name: "陳小華", title: "奈米薄膜分析", advisor: "張教授", venue: "A1" },
            { id: "S03", name: "林美玲", title: "綠能電池開發", advisor: "王教授", venue: "B1" }
        ];

        let currentUser = null;
        let activeStudent = null;
        let signaturePad;

        // 初始化簽名板
        window.onload = () => {
            const canvas = document.getElementById('signature-pad');
            signaturePad = new SignaturePad(canvas);
        };

        // --- 2. 登入邏輯 ---
        function login() {
            const name = document.getElementById('judgeName').value;
            const venue = document.getElementById('judgeVenue').value;
            if(!name || !venue) return alert("請輸入資訊");
            
            currentUser = { name, venue };
            document.getElementById('userInfo').innerText = `評審：${name} | 場地：${venue}`;
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('listSection').classList.remove('hidden');
            renderStudents();
        }

        // --- 3. 渲染名單 ---
        function renderStudents() {
            const container = document.getElementById('studentCards');
            container.innerHTML = '';
            const filtered = students.filter(s => s.venue === currentUser.venue);
            
            filtered.forEach(s => {
                const div = document.createElement('div');
                div.className = "bg-white p-6 rounded-lg shadow border-l-4 border-blue-500 hover:shadow-lg cursor-pointer transition";
                div.onclick = () => openScoring(s);
                div.innerHTML = `
                    <h4 class="font-bold text-lg">${s.name} (${s.id})</h4>
                    <p class="text-sm text-gray-600 mb-2 truncate">${s.title}</p>
                    <p class="text-xs text-gray-400">指導老師：${s.advisor}</p>
                `;
                container.appendChild(div);
            });
            document.getElementById('venueTitle').innerText = `${currentUser.venue} 場地學生名單`;
        }

        // --- 4. 評分表單操作 ---
        function openScoring(student) {
            activeStudent = student;
            document.getElementById('listSection').classList.add('hidden');
            document.getElementById('scoreSection').classList.remove('hidden');
            document.getElementById('scoringStudent').innerText = `正在評分：${student.name}`;
            clearForm();
        }

        function clearForm() {
            document.getElementById('profRaw').value = '';
            document.getElementById('techRaw').value = '';
            document.getElementById('judgeComment').value = '';
            document.getElementById('liveTotal').innerText = '0';
            signaturePad.clear();
        }

        // 自動加權計算
        document.addEventListener('input', () => {
            const prof = parseFloat(document.getElementById('profRaw').value) || 0;
            const tech = parseFloat(document.getElementById('techRaw').value) || 0;
            const total = Math.round((prof * 0.7) + (tech * 0.3));
            document.getElementById('liveTotal').innerText = total;
        });

        function clearSignature() { signaturePad.clear(); }

        function backToList() {
            document.getElementById('scoreSection').classList.add('hidden');
            document.getElementById('adminSection').classList.add('hidden');
            document.getElementById('listSection').classList.remove('hidden');
        }

        // --- 5. 提交資料 ---
        async function submitScore() {
            if(signaturePad.isEmpty()) return alert("請進行手寫簽名以示負責");
            
            const scoreData = {
                judge: currentUser.name,
                student: activeStudent.name,
                profScore: document.getElementById('profRaw').value,
                techScore: document.getElementById('techRaw').value,
                total: document.getElementById('liveTotal').innerText,
                comment: document.getElementById('judgeComment').value,
                signature: signaturePad.toDataURL(),
                timestamp: new Date().toLocaleString()
            };

            console.log("提交的 JSON 格式資料：", scoreData);
            
            // 此處執行 Firebase 上傳：
            // await db.collection('Scores').add(scoreData);

            alert(`${activeStudent.name} 評分成功！`);
            backToList();
        }

        // --- 6. 助理功能 ---
        function showAdmin() {
            document.getElementById('listSection').classList.add('hidden');
            document.getElementById('adminSection').classList.remove('hidden');
            // 此處應從資料庫抓取即時數據渲染排行榜
            document.getElementById('leaderboard').innerHTML = `
                <div class="p-2 bg-yellow-50 border">1. 張三 - 95分 (A1)</div>
                <div class="p-2 bg-gray-50 border">2. 李四 - 92分 (A1)</div>
                <div class="p-2 bg-gray-50 border">3. 王五 - 88分 (A1)</div>
            `;
        }

        function exportExcel() {
            // 這裡演示簡單匯出
            const ws = XLSX.utils.json_to_sheet([{姓名:"範例", 總分:95}]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Scores");
            XLSX.writeFile(wb, "2026研討會評分總表.xlsx");
        }

        function clearAllData() {
            if(confirm("確定要清空所有資料庫內容嗎？此操作不可逆！")) {
                alert("資料庫已重置。");
            }
        }
    </script>
</body>
</html>
