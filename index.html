<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>2026 淡江大學化工與材料研討會評分系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      .admin-tab.active {
        border-bottom: 3px solid #1e3a8a;
        color: #1e3a8a;
        font-weight: bold;
      }
      .dimension-card {
        border-left: 4px solid #3b82f6;
        padding: 1rem;
        margin-bottom: 1.5rem;
        background: #fff;
        border-radius: 0.75rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .btn-pos {
        background-color: #f0fdf4;
        color: #15803d;
        border: 1px solid #bbf7d0;
        padding: 2px 8px;
        border-radius: 99px;
        font-size: 11px;
        margin-right: 4px;
        margin-top: 4px;
        transition: 0.2s;
        cursor: pointer;
      }
      .btn-neg {
        background-color: #fef2f2;
        color: #b91c1c;
        border: 1px solid #fecaca;
        padding: 2px 8px;
        border-radius: 99px;
        font-size: 11px;
        margin-right: 4px;
        margin-top: 4px;
        transition: 0.2s;
        cursor: pointer;
      }
      .btn-pos:hover {
        background-color: #dcfce7;
        transform: translateY(-1px);
      }
      .btn-neg:hover {
        background-color: #fee2e2;
        transform: translateY(-1px);
      }
      .checkmark {
        color: #10b981;
        font-weight: bold;
        margin-left: auto;
        font-size: 14px;
      }
      .loading-overlay {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      .instruction-box {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        color: #1e40af;
        padding: 10px;
        border-radius: 12px;
        font-size: 12px;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body class="bg-slate-50 min-h-screen font-sans text-slate-900">
    <div id="loading" class="loading-overlay hidden flex-col">
      <div
        class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-900 mb-4"
      ></div>
      <p class="font-bold text-blue-900">同步雲端資料中...</p>
    </div>

    <nav class="bg-blue-900 text-white shadow-xl p-4 sticky top-0 z-50">
      <div class="container mx-auto flex justify-between items-center">
        <div>
          <h1 class="text-xl font-bold">2026 淡江大學化工與材料研討會</h1>
          <p class="text-xs opacity-70">2026/01/13 | 自動彙整評分助理</p>
        </div>
        <div class="flex gap-2">

          <button
            onclick="showSection('studentQuery')"
            class="text-xs bg-orange-600 px-4 py-2 rounded-full"
          >
            學生查詢
          </button>
          <button
            onclick="showSection('loginSection')"
            class="text-xs bg-blue-700 px-4 py-2 rounded-full"
          >
            評審入口
          </button>
          <button
            onclick="enterAdmin()"
            class="text-xs bg-red-700 px-4 py-2 rounded-full"
          >
            管理後台
          </button>
        </div>
      </div>
    </nav>

    <main class="container mx-auto p-4 max-w-6xl">
      <section id="publicResults" class="hidden space-y-6">
        <h2 class="text-3xl font-black text-center text-blue-900 my-8 italic">
          各場地即時成績看板 (自動更新)1/13啟用
        </h2>
        <p class="text-xs text-orange-800 font-bold">評審於當天16:00前可修改線上評分(部分委員採紙本評分,隔天上傳)</p>      
        <div
          id="publicRankContainer"
          class="grid grid-cols-1 md:grid-cols-2 gap-8"
        ></div>
      </section>

      <section
        id="studentQuery"
        class="hidden max-w-md mx-auto bg-white p-10 mt-12 rounded-3xl shadow-2xl border"
      >
        <h2 class="text-2xl font-black mb-6 text-center text-slate-800">
          成績與評語查詢
        </h2>
        <p class="text-xs text-orange-800 font-bold">評審於當天16:00前可修改評分(部分委員採紙本評分,隔天上傳)</p>      
        <div class="space-y-4">
          <input
            type="text"
            id="querySid"
            class="w-full p-3 border-2 rounded-xl outline-none focus:border-orange-500"
            placeholder="請輸入學號 (如: 613...)"
          />
          <button
            onclick="fetchStudentResult()"
            class="w-full bg-orange-600 text-white py-4 rounded-xl font-bold shadow-lg"
          >
            搜尋我的紀錄
          </button>
        </div>

        <div id="queryResult" class="mt-8 hidden space-y-4">
          <div class="p-4 bg-orange-50 rounded-2xl border border-orange-100">
            <p class="text-xs text-orange-800 font-bold">總平均分數</p>
            <p id="resAvg" class="text-5xl font-black text-orange-600">--</p>
          </div>
          <div id="resDetails" class="space-y-3"></div>
        </div>
      </section>

      <section
        id="loginSection"
        class="hidden max-w-md mx-auto bg-white p-10 mt-12 rounded-3xl shadow-2xl border"
      >
        <h2 class="text-2xl font-black mb-8 text-center text-slate-800">
          評審登入
        </h2>
        <div class="space-y-6">
          <select
            id="jVenue"
            class="w-full p-3 border-2 rounded-xl bg-slate-50 outline-none focus:border-blue-500"
          ></select>
          <input
            type="text"
            id="jName"
            class="w-full p-3 border-2 rounded-xl outline-none focus:border-blue-500"
            placeholder="請輸入評審姓名"
          />
          <input
            type="password"
            id="jPassword"
            class="w-full p-4 border-2 rounded-2xl outline-none focus:border-blue-600 text-center text-2xl tracking-widest"
            placeholder="請輸入人員代號"
          />
          <button
            onclick="judgeLogin()"
            class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition"
          >
            進入評分清單系統
          </button>
          <br />評分截止時間（2026年1月13日 下午 4:00）
        </div>
      </section>

      <section id="judgeDashboard" class="hidden space-y-6">
        <div class="flex justify-between items-center border-b pb-4">
          <h2 id="displayVenue" class="text-2xl font-black text-blue-900">
            場地名單
          </h2>
          <div class="text-right">
            <p id="displayRoom" class="text-slate-500 font-bold text-sm">
              教室：--
            </p>
            <p id="displayJudge" class="text-xs text-slate-400 font-bold">
              評審：--
            </p>
          </div>
        </div>
        <div
          id="studentListContainer"
          class="bg-white rounded-2xl shadow-md border overflow-hidden"
        ></div>
      </section>

      <section
        id="scoreSection"
        class="hidden max-w-4xl mx-auto bg-white p-8 rounded-3xl shadow-2xl border-t-8 border-blue-900"
      >
        <button
          onclick="showSection('judgeDashboard')"
          class="mb-6 text-blue-600 font-bold hover:underline"
        >
          ← 返回名單
        </button>
        <div class="instruction-box">
          <strong>💡 操作說明：</strong><br />
          點選下方維度中的
          <span class="text-green-700 font-bold">綠色按鈕</span> (正面評價) 或
          <span class="text-red-700 font-bold">紅色按鈕</span>
          (待加強建議)，評語會自動彙整至下方的「委員總結建議」。您也可以在格子內自行輸入文字，系統會即時同步。
        </div>

        <div class="mb-8 border-b pb-4 flex justify-between items-end">
          <div>
            <h2 id="scoringName" class="text-3xl font-black text-slate-800">
              姓名
            </h2>
            <p id="scoringTitle" class="text-slate-500 text-sm mt-1 italic">
              題目
            </p>
          </div>
          <p id="scoringAdvisor" class="text-blue-700 text-xs font-bold"></p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
          <div class="space-y-4">
            <h3 class="font-bold text-blue-700 border-b pb-2">
              A. 專業評語 (70%)
            </h3>
            <div class="dimension-card">
              <label class="block text-xs font-bold text-slate-500 mb-1"
                >報告內容建議</label
              >
              <input
                type="text"
                id="r_content"
                oninput="syncToOverall()"
                class="w-full text-xs border-b outline-none p-1"
                placeholder="輸入或點選下方按鈕..."
              />
              <div class="flex flex-wrap mt-2">
                <button
                  onclick="appendReason('r_content','架構完整，論述層次分明，展現高度專業。')"
                  class="btn-pos"
                >
                  架構完整，論述層次分明，展現高度專業。
                </button>
                <button
                  onclick="appendReason('r_content','邏輯推論嚴謹，研究數據具備說服力。')"
                  class="btn-pos"
                >
                  邏輯推論嚴謹，研究數據具備說服力。
                </button>
                <button
                  onclick="appendReason('r_content','研究目標明確，核心價值敘述詳盡。')"
                  class="btn-pos"
                >
                  研究目標明確，核心價值敘述詳盡。
                </button>
                <button
                  onclick="appendReason('r_content','文獻引述精確，能有效支撐個人論點。')"
                  class="btn-pos"
                >
                  文獻引述精確，能有效支撐個人論點。
                </button>

                <button
                  onclick="appendReason('r_content','內容重心不夠聚焦，建議重新梳理研究動機。')"
                  class="btn-neg"
                >
                  內容重心不夠聚焦，建議重新梳理研究動機。
                </button>
                <button
                  onclick="appendReason('r_content','投影片文字過於冗長，應多利用圖表呈現關鍵數據。')"
                  class="btn-neg"
                >
                  投影片文字過於冗長，應多利用圖表呈現關鍵數據。
                </button>
                <button
                  onclick="appendReason('r_content','部分科學方法論述不足，建議加強實驗細節之說明。')"
                  class="btn-neg"
                >
                  部分科學方法論述不足，建議加強實驗細節之說明。
                </button>
                <button
                  onclick="appendReason('r_content','結論與數據關聯性稍弱，建議強化論證過程。')"
                  class="btn-neg"
                >
                  結論與數據關聯性稍弱，建議強化論證過程。
                </button>
              </div>
            </div>
            <div class="dimension-card">
              <label class="block text-xs font-bold text-slate-500 mb-1"
                >表達流暢度建議</label
              >
              <input
                type="text"
                id="r_fluency"
                oninput="syncToOverall()"
                class="w-full text-xs border-b outline-none p-1"
              />
              <div class="flex flex-wrap mt-2">
                <button
                  onclick="appendReason('r_fluency','口齒清晰、敘事自然流暢，極具感染力。')"
                  class="btn-pos"
                >
                  口齒清晰、敘事自然流暢，極具感染力。
                </button>
                <button
                  onclick="appendReason('r_fluency','表現自信沉穩，能帶領聽眾掌握演講節奏。')"
                  class="btn-pos"
                >
                  表現自信沉穩，能帶領聽眾掌握演講節奏。
                </button>
                <button
                  onclick="appendReason('r_fluency','對內容極度熟稔，展現優異的專業素養。')"
                  class="btn-pos"
                >
                  對內容極度熟稔，展現優異的專業素養。
                </button>
                <button
                  onclick="appendReason('r_fluency','唸稿感較重，建議增加與觀眾的眼神互動。')"
                  class="btn-neg"
                >
                  唸稿感較重，建議增加與觀眾的眼神互動。
                </button>
                <button
                  onclick="appendReason('r_fluency','說話語速偏快，建議適時停頓以利聽眾吸收。')"
                  class="btn-neg"
                >
                  說話語速偏快，建議適時停頓以利聽眾吸收。
                </button>
                <button
                  onclick="appendReason('r_fluency','表達稍顯生硬，建議加強各章節間的語意銜接。')"
                  class="btn-neg"
                >
                  表達稍顯生硬，建議加強各章節間的語意銜接。
                </button>
              </div>
            </div>
            <div class="dimension-card">
              <label class="block text-xs font-bold text-slate-500 mb-1"
                >提問詮釋建議</label
              >
              <input
                type="text"
                id="r_qa"
                oninput="syncToOverall()"
                class="w-full text-xs border-b outline-none p-1"
              />
              <div class="flex flex-wrap mt-2">
                <button
                  onclick="appendReason('r_qa','答詢切中要領，對研究細節掌握度極高。')"
                  class="btn-pos"
                >
                  答詢切中要領，對研究細節掌握度極高。
                </button>
                <button
                  onclick="appendReason('r_qa','邏輯應變力強，能針對質疑給予科學性回覆。')"
                  class="btn-pos"
                >
                  邏輯應變力強，能針對質疑給予科學性回覆。
                </button>
                <button
                  onclick="appendReason('r_qa','態度謙和得體，能正面積極與委員討論。')"
                  class="btn-pos"
                >
                  態度謙和得體，能正面積極與委員討論。
                </button>
                <button
                  onclick="appendReason('r_qa','回覆過於簡略，建議對問題核心進行深度論述。')"
                  class="btn-neg"
                >
                  回覆過於簡略，建議對問題核心進行深度論述。
                </button>
                <button
                  onclick="appendReason('r_qa','答詢內容與研究方法未盡一致，應重新釐清觀念。')"
                  class="btn-neg"
                >
                  答詢內容與研究方法未盡一致，應重新釐清觀念。
                </button>
                <button
                  onclick="appendReason('r_qa','面對提問反應較慢，建議加強模擬訓練以提升應變。')"
                  class="btn-neg"
                >
                  面對提問反應較慢，建議加強模擬訓練以提升應變。
                </button>
              </div>
            </div>
            <div class="bg-blue-50 p-4 rounded-xl border">
              <label class="block text-xs font-bold text-blue-800 mb-1"
                >專業原始分 (0-100)</label
              >
              <input
                type="number"
                id="profRaw"
                class="w-full p-2 text-2xl font-black rounded-lg border-2 outline-none"
                oninput="calcTotal()"
              />
            </div>
          </div>

          <div class="space-y-4">
            <h3 class="font-bold text-green-700 border-b pb-2">
              B. 技術評語 (30%)
            </h3>
            <div class="dimension-card" style="border-left-color: #22c55e">
              <label class="block text-xs font-bold text-slate-500 mb-1"
                >時間掌控建議</label
              >
              <input
                type="text"
                id="r_time"
                oninput="syncToOverall()"
                class="w-full text-xs border-b outline-none p-1"
              />
              <div class="flex flex-wrap mt-2">
                <button
                  onclick="appendReason('r_time','發表節奏掌握完美，精確完成報告。')"
                  class="btn-pos"
                >
                  發表節奏掌握完美，精確完成報告。
                </button>
                <button
                  onclick="appendReason('r_time','內容分配均衡，在時限內完整呈現研究精華。')"
                  class="btn-pos"
                >
                  內容分配均衡，在時限內完整呈現研究精華。
                </button>
                <button
                  onclick="appendReason('r_time','發表超時，建議重新精簡簡報頁數與論述重點。')"
                  class="btn-neg"
                >
                  發表超時，建議重新精簡簡報頁數與論述重點。
                </button>
                <button
                  onclick="appendReason('r_time','前言佔比過高，導致後段核心成果描述太匆促。')"
                  class="btn-neg"
                >
                  前言佔比過高，導致後段核心成果描述太匆促。
                </button>
                <button
                  onclick="appendReason('r_time','剩餘時間過多，建議增加對研究成果的深度解說。')"
                  class="btn-neg"
                >
                  剩餘時間過多，建議增加對研究成果的深度解說。
                </button>
              </div>
            </div>
            <div class="dimension-card" style="border-left-color: #22c55e">
              <label class="block text-xs font-bold text-slate-500 mb-1"
                >服儀儀態建議</label
              >
              <input
                type="text"
                id="r_outfit"
                oninput="syncToOverall()"
                class="w-full text-xs border-b outline-none p-1"
              />
              <div class="flex flex-wrap mt-2">
                <button
                  onclick="appendReason('r_outfit','服儀莊重得體，展現優良的專業形象。')"
                  class="btn-pos"
                >
                  服儀莊重得體，展現優良的專業形象。
                </button>
                <button
                  onclick="appendReason('r_outfit','舉止端莊大方，符合學術場合禮儀。')"
                  class="btn-pos"
                >
                  舉止端莊大方，符合學術場合禮儀。
                </button>
                <button
                  onclick="appendReason('r_outfit','服裝建議可以更為正式，以增進整體專業感。')"
                  class="btn-neg"
                >
                  服裝建議可以更為正式，以增進整體專業感。
                </button>
                <button
                  onclick="appendReason('r_outfit','表情與肢體儀態略顯緊張，可透過多加練習提升自然度。')"
                  class="btn-neg"
                >
                  表情與肢體儀態略顯緊張，可透過多加練習提升自然度。
                </button>
              </div>
            </div>
            <div class="bg-green-50 p-4 rounded-xl border">
              <label class="block text-xs font-bold text-green-800 mb-1"
                >技術原始分 (0-100)</label
              >
              <input
                type="number"
                id="techRaw"
                class="w-full p-2 text-2xl font-black rounded-lg border-2 outline-none"
                oninput="calcTotal()"
              />
            </div>
            <div class="p-4 bg-slate-100 rounded-xl border mt-4">
              <label class="block text-sm font-bold text-blue-900 mb-2"
                >● 委員總結建議：</label
              >
              <textarea
                id="judgeComment"
                class="w-full p-3 text-sm border-2 rounded-xl h-40 outline-none"
                placeholder="彙整中..."
              ></textarea>
            </div>
          </div>
        </div>

        <div
          class="mt-8 flex flex-col md:flex-row justify-between items-center bg-slate-900 text-white p-8 rounded-3xl gap-4"
        >
          <div>
            加權成績：<span
              id="finalScoreDisplay"
              class="text-6xl font-black text-yellow-400"
              >0</span
            >分
          </div>
          <div class="flex gap-2">
            <button
              onclick="deleteGradingFromCloud()"
              class="bg-red-600 px-6 py-4 rounded-2xl font-bold"
            >
              刪除紀錄
            </button>
            <button
              onclick="submitGradingToCloud()"
              class="bg-blue-600 px-12 py-4 rounded-2xl font-black text-xl shadow-xl"
            >
              送出評分
            </button>
          </div>
        </div>
      </section>


      <section id="scoreSectionPoster" class="hidden max-w-4xl mx-auto bg-white p-8 rounded-3xl shadow-2xl border-t-8 border-green-600">
        <button onclick="showSection('judgeDashboard')" class="mb-6 text-green-600 font-bold hover:underline">← 返回名單</button>
  
        <div class="mb-8 border-b pb-4">
          <h2 id="scoringNamePoster" class="text-3xl font-black text-slate-800">姓名</h2>
          <p id="scoringTitlePoster" class="text-slate-500 text-sm mt-1">專題名稱</p>
        </div>

        <div class="grid grid-cols-1 gap-6 mb-8">
          <div class="dimension-card" style="border-left-color: #059669">
            <label class="block text-sm font-bold text-slate-700 mb-2">1. 研究內容 (60%) [包含創意、價值、應用性、理解性]</label>
            <input type="number" id="p_research" oninput="calcTotalPoster()" class="w-full p-3 text-xl border-2 rounded-xl outline-none focus:border-green-500" placeholder="0-100">
          </div>

          <div class="dimension-card" style="border-left-color: #10b981">
            <label class="block text-sm font-bold text-slate-700 mb-2">2. 整體造型 (20%) [包含海報規劃、美觀、色彩]</label>
            <input type="number" id="p_design" oninput="calcTotalPoster()" class="w-full p-3 text-xl border-2 rounded-xl outline-none focus:border-green-500" placeholder="0-100">
          </div>

          <div class="dimension-card" style="border-left-color: #34d399">
            <label class="block text-sm font-bold text-slate-700 mb-2">3. 學生應答表現 (20%) [包含對專題瞭解、表達能力]</label>
            <input type="number" id="p_qa" oninput="calcTotalPoster()" class="w-full p-3 text-xl border-2 rounded-xl outline-none focus:border-green-500" placeholder="0-100">
          </div>

          <div class="p-4 bg-slate-100 rounded-xl border">
            <label class="block text-sm font-bold text-blue-900 mb-2">● 評審總結建議：</label>
            <textarea id="judgeCommentPoster" class="w-full p-3 text-sm border-2 rounded-xl h-32 outline-none"></textarea>
          </div>
        </div>

        <div class="mt-8 flex flex-col md:flex-row justify-between items-center bg-green-900 text-white p-8 rounded-3xl gap-4">
          <div>海報競賽加權成績：<span id="finalScorePoster" class="text-6xl font-black text-yellow-400">0</span>分</div>
          <button onclick="submitPosterScore()" class="bg-green-600 px-12 py-4 rounded-2xl font-black text-xl shadow-xl hover:bg-green-700 transition">送出海報評分</button>
        </div>
      </section>

      <section
        id="adminDashboard"
        class="hidden bg-white rounded-3xl shadow-xl p-8"
      >
        <div class="flex gap-6 border-b-2 mb-8">
          <button
            onclick="toggleAdminTab('venue')"
            id="tab-btn-venue"
            class="admin-tab active pb-4 px-2"
          >
            場地與密碼
          </button>
          <button
            onclick="toggleAdminTab('student')"
            id="tab-btn-student"
            class="admin-tab pb-4 px-2"
          >
            名單匯入
          </button>
        </div>
        <div id="admin-venue" class="admin-content space-y-6">
          <div
            id="venueConfigContainer"
            class="grid grid-cols-1 md:grid-cols-2 gap-6"
          ></div>
          <div class="flex gap-4">
            <button
              onclick="saveAdminConfig()"
              class="flex-1 bg-blue-900 text-white py-3 rounded-xl font-bold"
            >
              儲存配置
            </button>
            <button
              onclick="exportAllScores()"
              class="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold"
            >
              📊 匯生成績 Excel(當天下午16:00後)
            </button>
          </div>
        </div>
        <div id="admin-student" class="admin-content hidden space-y-6">
          <div
            class="p-6 border-2 border-dashed rounded-2xl bg-slate-50 flex justify-between items-center"
          >
            <input
              type="file"
              onchange="handleExcelImport(this)"
              class="text-sm"
            />
            <button
              onclick="clearStudentsCloud()"
              class="bg-red-50 text-red-600 px-6 py-2 rounded-xl"
            >
              清空名單
            </button>
          </div>
          <div class="overflow-x-auto">
            <table
              id="adminStudentTable"
              class="w-full border-collapse block md:table"
            ></table>
          </div>
        </div>
      </section>

    </main>

    <script>
      // Firebase 配置
      const firebaseConfig = {
        apiKey: "AIzaSyBNa3SAk7yqzRjPyYuKZyLIJesm6M7c57w",
        authDomain: "cme-seminar2026.firebaseapp.com",
        projectId: "cme-seminar2026",
        storageBucket: "cme-seminar2026.firebasestorage.app",
        messagingSenderId: "61658181836",
        appId: "1:61658181836:web:6c8d964c66512575dc9269",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // 1. 初始化場地清單與配置
      let students = [],
        scores = [],
        currentUser = null,
        activeStudent = null;
      let venueConfig = {
        A1: { room: "", judges: ["", ""], passwords: ["", ""] },
        A2: { room: "", judges: ["", ""], passwords: ["", ""] },
        B1: { room: "", judges: ["", ""], passwords: ["", ""] },
        B2: { room: "", judges: ["", ""], passwords: ["", ""] },
        C1: { room: "", judges: ["", ""], passwords: ["", ""] },
      };
      const venues = ["A1", "A2", "B1", "B2", "C1"];

     window.onload = async () => {
        toggleLoading(true);
        try {
          const configDoc = await db.collection("Settings").doc("VenueConfig").get();
          if (configDoc.exists) {
            const cloudData = configDoc.data();
            // 核心修正：合併雲端資料，確保 C1 不會被刪除
            venues.forEach(v => {
              if (cloudData[v]) venueConfig[v] = cloudData[v];
            });
          }
          renderAdminConfigUI();
          renderVenueSelect(); 

          // 即時監聽
          db.collection("Students").onSnapshot((snap) => {
            students = snap.docs.map((doc) => doc.data());
            renderAdminList();
            if (currentUser) renderStudentList();
          });
          db.collection("Scores").onSnapshot((snap) => {
            scores = snap.docs.map((doc) => doc.data());
            renderPublicResults();
            if (currentUser) renderStudentList();
          });
        } catch (e) {
          console.error(e);
        } finally {
          toggleLoading(false);
          showSection("publicResults");
        }
      };

      // 修正後台介面生成邏輯
      function renderAdminConfigUI() {
        const container = document.getElementById("venueConfigContainer");
        container.innerHTML = venues.map(v => `
          <div class="p-5 border rounded-2xl bg-slate-50">
            <div class="flex gap-2 mb-4">
              <span class="bg-blue-900 text-white px-3 py-1 rounded font-bold">${v}</span>
              <input type="text" id="vRoom_${v}" value="${venueConfig[v].room || ''}" placeholder="教室名稱" class="flex-1 border-b bg-transparent outline-none">
            </div>
            <div class="grid grid-cols-2 gap-2">
              <input type="text" id="vJudge_${v}_1" value="${venueConfig[v].judges[0] || ''}" placeholder="評審1姓名" class="p-2 border rounded text-xs">
              <input type="text" id="vPwd_${v}_1" value="${venueConfig[v].passwords ? venueConfig[v].passwords[0] : ''}" placeholder="密碼1" class="p-2 border rounded text-xs">
              <input type="text" id="vJudge_${v}_2" value="${venueConfig[v].judges[1] || ''}" placeholder="評審2姓名" class="p-2 border rounded text-xs">
              <input type="text" id="vPwd_${v}_2" value="${venueConfig[v].passwords ? venueConfig[v].passwords[1] : ''}" placeholder="密碼2" class="p-2 border rounded text-xs">
            </div>
          </div>
        `).join("");
      }
      
      // 修正儲存邏輯，確保循環處理 C1
      async function saveAdminConfig() {
        toggleLoading(true);
        try {
          venues.forEach((v) => {
            venueConfig[v] = {
              room: document.getElementById(`vRoom_${v}`).value,
              judges: [
                document.getElementById(`vJudge_${v}_1`).value,
                document.getElementById(`vJudge_${v}_2`).value,
              ],
              passwords: [
                document.getElementById(`vPwd_${v}_1`).value,
                document.getElementById(`vPwd_${v}_2`).value,
              ],
            };
          });
          await db.collection("Settings").doc("VenueConfig").set(venueConfig);
          alert("C1 與所有場地配置已成功儲存！");
        } catch (e) {
          alert("儲存失敗");
        } finally {
          toggleLoading(false);
        }
      }


      //評審登入
      function judgeLogin() {
        const v = document.getElementById("jVenue").value;
        const n = document.getElementById("jName").value.trim();
        if (!n || !venueConfig[v].judges.includes(n))
          return alert("姓名不在該場地評審名單中");
        const p = document.getElementById("jPassword").value.trim();
        if (!p) return alert("請輸入密碼");
        let found = null;
        for (let v of venues) {
          const cfg = venueConfig[v];
          if (cfg && cfg.passwords) {
            const idx = cfg.passwords.indexOf(p);
            if (idx !== -1) {
              found = { name: cfg.judges[idx], venue: v, room: cfg.room };
              break;
            }
          }
        }
        if (found) {
          currentUser = found;
          document.getElementById(
            "displayVenue"
          ).innerText = `${found.venue} 場地清單`;
          document.getElementById(
            "displayRoom"
          ).innerText = `教室：${found.room}`;
          document.getElementById(
            "displayJudge"
          ).innerText = `評審：${found.name}`;
          showSection("judgeDashboard");
          renderStudentList();
        } else {
          alert("密碼錯誤！");
        }
      }

      async function fetchStudentResult() {
        const sid = document.getElementById("querySid").value.trim();
        if (!sid) return alert("請輸入學號");
        toggleLoading(true);
        try {
          const snap = await db
            .collection("Scores")
            .where("studentId", "==", sid)
            .get();
          if (snap.empty) {
            alert("尚未有評分紀錄");
            document.getElementById("queryResult").classList.add("hidden");
          } else {
            let sum = 0,
              html = "";
            snap.forEach((doc) => {
              const d = doc.data();
              sum += d.total;
              html += `<div class="p-4 bg-white border rounded-xl text-sm"><p class="font-bold text-blue-900 border-b mb-2">評審建議：</p><p class="italic text-slate-600">${
                d.feedback_json.summary || "無評語"
              }</p></div>`;
            });
            document.getElementById("resAvg").innerText = Math.round(
              sum / snap.size
            );
            document.getElementById("resDetails").innerHTML = html;
            document.getElementById("queryResult").classList.remove("hidden");
          }
        } finally {
          toggleLoading(false);
        }
      }

      function openScoring(sid) {
        activeStudent = students.find((s) => s.id === sid);
        document.getElementById("scoringName").innerText = activeStudent.name;
        document.getElementById("scoringTitle").innerText =
          activeStudent.title || "";
        document.getElementById("scoringAdvisor").innerText = `指導教授：${
          activeStudent.advisor || "--"
        }`;

        const history = scores.find(
          (sc) => sc.studentId === sid && sc.judge === currentUser.name
        );
        // 重置所有欄位
        [
          "profRaw",
          "techRaw",
          "judgeComment",
          "r_content",
          "r_fluency",
          "r_qa",
          "r_time",
          "r_outfit",
        ].forEach((id) => (document.getElementById(id).value = ""));
        document.getElementById("finalScoreDisplay").innerText = "0";

        if (history) {
          document.getElementById("profRaw").value = history.profRaw || "";
          document.getElementById("techRaw").value = history.techRaw || "";
          document.getElementById("judgeComment").value =
            history.feedback_json?.summary || "";
          document.getElementById("finalScoreDisplay").innerText =
            history.total || "0";
          if (history.details) {
            ["content", "fluency", "qa", "time", "outfit"].forEach((k) => {
              if (history.details[k])
                document.getElementById(`r_${k}`).value =
                  history.details[k].reason || "";
            });
          }
        }
        showSection("scoreSection");

        // 檢查時間是否已過
        const isExpired = new Date().getTime() > DEADLINE;
        const submitBtn = document.querySelector(
          "button[onclick='submitGradingToCloud()']"
        );
        const deleteBtn = document.querySelector(
          "button[onclick='deleteGradingFromCloud()']"
        );

        if (isExpired) {
          submitBtn.classList.add("hidden");
          deleteBtn.classList.add("hidden");
          // 可以額外提示
          document.getElementById(
            "finalScoreDisplay"
          ).parentElement.innerHTML += `<p class="text-red-500 text-sm mt-2">評分已截止，目前僅供檢視</p>`;
        } else {
          submitBtn.classList.remove("hidden");
          deleteBtn.classList.remove("hidden");
        }
      }

      async function deleteGradingFromCloud() {
        if (!checkDeadline()) return; // 先檢查時間

        if (!confirm("確定刪除此生評分紀錄？")) return;
        toggleLoading(true);
        try {
          await db
            .collection("Scores")
            .doc(`${currentUser.name}_${activeStudent.id}`)
            .delete();
          alert("已刪除");
          showSection("judgeDashboard");
        } finally {
          toggleLoading(false);
        }
      }

      async function submitGradingToCloud() {
        if (!checkDeadline()) return; // 先檢查時間

        const p = document.getElementById("profRaw").value,
          t = document.getElementById("techRaw").value;
        if (p === "" || t === "") return alert("請輸入分數");
        toggleLoading(true);
        try {
          await db
            .collection("Scores")
            .doc(`${currentUser.name}_${activeStudent.id}`)
            .set({
              judge: currentUser.name,
              venue: currentUser.venue,
              studentId: activeStudent.id,
              studentName: activeStudent.name,
              total: parseInt(
                document.getElementById("finalScoreDisplay").innerText
              ),
              profRaw: parseInt(p),
              techRaw: parseInt(t),
              details: {
                content: { reason: document.getElementById("r_content").value },
                fluency: { reason: document.getElementById("r_fluency").value },
                qa: { reason: document.getElementById("r_qa").value },
                time: { reason: document.getElementById("r_time").value },
                outfit: { reason: document.getElementById("r_outfit").value },
              },
              feedback_json: {
                summary: document.getElementById("judgeComment").value,
              },
              timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            });
          alert("評分成功");
          showSection("judgeDashboard");
        } finally {
          toggleLoading(false);
        }
      }

      function syncToOverall() {
        const map = [
          { id: "r_content", l: "內容" },
          { id: "r_fluency", l: "流暢" },
          { id: "r_qa", l: "應答" },
          { id: "r_time", l: "時間" },
          { id: "r_outfit", l: "服儀" },
        ];
        document.getElementById("judgeComment").value = map
          .map((i) => {
            const v = document.getElementById(i.id).value.trim();
            return v ? `【${i.l}】${v}` : "";
          })
          .filter((s) => s)
          .join("\n");
      }

      function calcTotal() {
        const p = parseFloat(document.getElementById("profRaw").value) || 0,
          t = parseFloat(document.getElementById("techRaw").value) || 0;
        document.getElementById("finalScoreDisplay").innerText = Math.round(
          p * 0.7 + t * 0.3
        );
      }

      function appendReason(id, text) {
        const el = document.getElementById(id);
        if (!el.value.includes(text)) el.value += (el.value ? " " : "") + text;
        syncToOverall();
      }


      // 多欄位即時排行榜邏輯 (優化版)
      function renderPublicResults() {
        const container = document.getElementById("publicRankContainer");
        container.innerHTML = venues
          .map((v) => {
            const room = venueConfig[v]?.room || "未設定";
            const judges = venueConfig[v]?.judges || ["評審1", "評審2"];
            const vScores = scores.filter((s) => s.venue === v);

            const grouped = {};
      
            // 1. 分組並填入分數（確保同一評審重複送出時是覆蓋而非累加）
            vScores.forEach((s) => {
              if (!grouped[s.studentId]) {
                grouped[s.studentId] = {
                  name: s.studentName,
                  j1: null,
                  j2: null
                };
              }
              // 判斷是哪位評審的分數
              if (s.judge === judges[0]) grouped[s.studentId].j1 = s.total;
              else if (s.judge === judges[1]) grouped[s.studentId].j2 = s.total;
            });

            // 2. 計算平均並轉為陣列
            const rank = Object.values(grouped).map(item => {
              const validScores = [item.j1, item.j2].filter(score => score !== null);
              const sum = validScores.reduce((a, b) => a + b, 0);
              const count = validScores.length;
        
              return {
                ...item,
                // 保留一位小數，若無分數則為 0
                avg: count > 0 ? (sum / count).toFixed(1) : "0.0",
                displayJ1: item.j1 ?? "--",
                displayJ2: item.j2 ?? "--"
              };
            });

            // 3. 排序 (由高到低)
            rank.sort((a, b) => parseFloat(b.avg) - parseFloat(a.avg));

            // 4. 生成 HTML (這部分維持你原本的 Tailwind 樣式)
            return `
            <div class="bg-white p-6 rounded-3xl shadow border-t-8 border-blue-900">
              <h3 class="font-black text-xl mb-4 border-b pb-2 flex justify-between">
                <span>${v} 場地 (${room})</span>
                <span class="text-xs text-blue-500 animate-pulse">Live</span>
              </h3>
              <div class="space-y-3">
                <div class="grid grid-cols-5 text-[10px] text-slate-400 font-bold px-2">
                  <div class="col-span-2">學生姓名</div>
                  <div class="text-center">評審1</div>
                  <div class="text-center">評審2</div>
                  <div class="text-right">平均</div>
                </div>
                ${
                  rank.length
                    ? rank.map((r, i) => `
                  <div class="grid grid-cols-5 items-center text-sm p-2 ${i === 0 ? "bg-yellow-50 rounded-lg" : ""}">
                    <div class="col-span-2 font-bold text-slate-700">${i + 1}. ${r.name}</div>
                    <div class="text-center font-mono text-xs text-slate-400">${r.displayJ1}</div>
                    <div class="text-center font-mono text-xs text-slate-400">${r.displayJ2}</div>
                    <div class="text-right font-black ${i === 0 ? "text-blue-700" : "text-slate-600"}">${r.avg}</div>
                  </div>`).join("")
                    : '<p class="text-xs text-slate-300 text-center py-4">⏳ 等待評分中...</p>'
                }
              </div>
            </div>`;
          })
          .join("");
      }

      //增加海報評分按鈕
      // 修正評分清單顯示：依據場地切換 A1-B2(研討會) 或 C1(海報)
      function renderStudentList() {
        const container = document.getElementById("studentListContainer");
        const filtered = students.filter((s) => s.venue === currentUser.venue);
  
        container.innerHTML = filtered.map((s) => {
          const isDone = scores.some(sc => sc.studentId === s.id && sc.judge === currentUser.name);
    
          // 如果場地是 C1，按鈕變為綠色且指向海報評分頁面
          let btnHtml = "";
          if (currentUser.venue === 'C1') {
            btnHtml = `<button onclick="openPosterScoring('${s.id}')" class="bg-green-600 text-white px-3 py-1 rounded-lg text-xs">海報評分</button>`;
          } else {
            btnHtml = `<button onclick="openScoring('${s.id}')" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-xs">進入評分</button>`;
          }

          return `
            <div class="flex justify-between items-center p-4 border-b hover:bg-slate-50">
              <div>
                <p class="text-[10px] text-slate-400 font-mono">${s.id}</p>
                <h3 class="font-bold">${s.name}</h3>
                ${isDone ? '<span class="text-[10px] text-green-600 font-bold">● 已完成</span>' : ''}
              </div>
              ${btnHtml}
            </div>`;
        }).join("");
      }

      function renderAdminList() {
        const tableBody = document.getElementById("adminStudentTable");

        // 1. 表頭：在手機端隱藏 (hidden)，中視窗以上顯示 (md:table-header-group)
        const header = `
          <thead class="hidden md:table-header-group bg-slate-100 font-bold">
            <tr>
              <td class="p-3 border">學號 (ID)</td>
              <td class="p-3 border">姓名</td>
              <td class="p-3 border">指導教授</td>
              <td class="p-3 border">論文題目</td>
              <td class="p-3 border text-center">場地</td>
            </tr>
          </thead>`;

        // 2. 資料列：手機端轉為卡片 (block + shadow)，中視窗以上恢復為表格列 (md:table-row)
        const rows = students
          .map(
            (s) => `
          <tr class="block md:table-row mb-4 md:mb-0 bg-white border md:border-b shadow-sm md:shadow-none rounded-xl md:rounded-none p-4 md:p-0">
      
            <td data-label="學號" class="block md:table-cell p-1 md:p-3 text-xs font-mono text-slate-500 md:text-slate-900 
              before:content-[attr(data-label)] before:md:hidden before:font-bold before:mr-2 before:text-slate-400">
              ${s.id}
            </td>
      
            <td data-label="姓名" class="block md:table-cell p-1 md:p-3 font-bold text-lg md:text-base
              before:content-[attr(data-label)] before:md:hidden before:font-bold before:mr-2 before:text-slate-400">
              ${s.name}
            </td>
      
            <td data-label="指導教授" class="block md:table-cell p-1 md:p-3 text-sm
              before:content-[attr(data-label)] before:md:hidden before:font-bold before:mr-2 before:text-slate-400">
              ${s.advisor || "--"}
            </td>
      
            <td data-label="論文題目" class="block md:table-cell p-1 md:p-3 text-xs text-slate-600
              before:content-[attr(data-label)] before:md:hidden before:font-bold before:mr-2 before:text-slate-400">
              ${s.title || "--"}
            </td>
      
            <td data-label="場地" class="block md:table-cell p-1 md:p-3 text-left md:text-center
              before:content-[attr(data-label)] before:md:hidden before:font-bold before:mr-2 before:text-slate-400">
              <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-bold inline-block mt-1 md:mt-0">
                ${s.venue}
              </span>
            </td>
      
          </tr>
        `
          )
          .join("");

        tableBody.innerHTML =
          header + `<tbody class="block md:table-row-group">${rows}</tbody>`;
      }

      async function handleExcelImport(input) {
        const reader = new FileReader();
        reader.onload = async (e) => {
          const data = XLSX.read(new Uint8Array(e.target.result), {
            type: "array",
          });
          const json = XLSX.utils.sheet_to_json(
            data.Sheets[data.SheetNames[0]],
            { header: 1 }
          );
          const batch = db.batch();
          json.slice(1).forEach((r) => {
            if (r[0])
              batch.set(db.collection("Students").doc(String(r[0])), {
                id: String(r[0]),
                name: r[1],
                advisor: r[2],
                title: r[3],
                venue: r[4] ? String(r[4]).toUpperCase().trim() : "未分配",
              });
          });
          await batch.commit();
          alert("匯入成功");
        };
        reader.readAsArrayBuffer(input.files[0]);
      }

      function exportAllScores() {
        const data = scores.map((s) => ({
          場地: s.venue,
          評審: s.judge,
          學生: s.studentName,
          學號: s.studentId,
          專業分: s.profRaw,
          技術分: s.techRaw,
          加權總分: s.total,
          評語: s.feedback_json.summary,
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Scores");
        XLSX.writeFile(wb, `成績匯出_${new Date().toLocaleDateString()}.xlsx`);
      }

      function toggleAdminTab(t) {
        document
          .querySelectorAll(".admin-content")
          .forEach((c) => c.classList.add("hidden"));
        document
          .querySelectorAll(".admin-tab")
          .forEach((b) => b.classList.remove("active"));
        document.getElementById(`admin-${t}`).classList.remove("hidden");
        document.getElementById(`tab-btn-${t}`).classList.add("active");
      }
      function showSection(id) {
        document
          .querySelectorAll("main > section")
          .forEach((s) => s.classList.add("hidden"));
        document.getElementById(id).classList.remove("hidden");
        window.scrollTo(0, 0);
      }
      function toggleLoading(s) {
        document.getElementById("loading").classList.toggle("hidden", !s);
      }
      function enterAdmin() {
        if (prompt("請輸入管理密碼,提示t~4") === "tedx2614")
          showSection("adminDashboard");
      }
      function clearStudentsCloud() {
        if (confirm("確定清空？"))
          db.collection("Students")
            .get()
            .then((qs) => {
              const b = db.batch();
              qs.forEach((d) => b.delete(d.ref));
              b.commit();
            });
      }

      function renderVenueSelect() {
        const select = document.getElementById("jVenue");
        if (!select) return;

        // 遍歷 A1, A2, B1, B2 等場地
        select.innerHTML = venues
          .map((v) => {
            // 取得該場地設定的教室名稱，若沒填寫則顯示場地編號
            const roomName =
              venueConfig[v] && venueConfig[v].room
                ? venueConfig[v].room
                : `未設定教室`;
            return `<option value="${v}">${roomName} (${v}場地)</option>`;
          })
          .join("");
      }


      // 計算海報競賽分數：研究(60%) + 造型(20%) + 應答(20%)
      function calcTotalPoster() {
        const r = parseFloat(document.getElementById("p_research").value) || 0;
        const d = parseFloat(document.getElementById("p_design").value) || 0;
        const q = parseFloat(document.getElementById("p_qa").value) || 0;
  
        // 根據 PDF 規定計算加權平均 [cite: 13, 27]
        const total = Math.round(r * 0.6 + d * 0.2 + q * 0.2);
        document.getElementById("finalScorePoster").innerText = total;
      }

      // 開啟海報評分介面 (可修改原本的 openScoring 邏輯來決定導向哪一頁)
      function openPosterScoring(sid) {
        activeStudent = students.find((s) => s.id === sid);
        document.getElementById("scoringNamePoster").innerText = activeStudent.name;
        document.getElementById("scoringTitlePoster").innerText = activeStudent.title || "無題目";
  
        // 清空與重置
        ["p_research", "p_design", "p_qa", "judgeCommentPoster"].forEach(id => document.getElementById(id).value = "");
        document.getElementById("finalScorePoster").innerText = "0";
  
        showSection("scoreSectionPoster");
      }

      // 送出海報評定至 Firebase
      async function submitPosterScore() {
        if (!checkDeadline()) return;

        const r = document.getElementById("p_research").value;
        const d = document.getElementById("p_design").value;
        const q = document.getElementById("p_qa").value;
  
        if (r === "" || d === "" || q === "") return alert("請完整填寫三項評分");

        toggleLoading(true);
        try {
          await db.collection("Scores").doc(`Poster_${currentUser.name}_${activeStudent.id}`).set({
            type: "PosterCompetition", // 標記為海報競賽
            judge: currentUser.name,
            studentId: activeStudent.id,
            studentName: activeStudent.name,
            total: parseInt(document.getElementById("finalScorePoster").innerText),
            rawScores: { research: parseInt(r), design: parseInt(d), qa: parseInt(q) },
            feedback: document.getElementById("judgeCommentPoster").value,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          });
          alert("海報競賽評分成功！");
          showSection("judgeDashboard");
        } finally {
          toggleLoading(false);
        }
      }

      // 定義截止時間（例如：2026年1月13日 下午 4:00）
      const DEADLINE = new Date("2026-01-13T16:00:00").getTime();

      function checkDeadline() {
        const now = new Date().getTime();
        if (now > DEADLINE) {
          alert("【系統提示】評分期限已過，無法再新增、修改或刪除評分紀錄。");
          return false;
        }
        return true;
      }
    </script>
  </body>
</html>
