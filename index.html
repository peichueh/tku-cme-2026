<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>2026 æ·¡æ±ŸåŒ–æç ”è¨æœƒè©•åˆ†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      .admin-tab.active {
        border-bottom: 3px solid #1e3a8a;
        color: #1e3a8a;
        font-weight: bold;
      }
      .dimension-card {
        border-left: 4px solid #3b82f6;
        padding-left: 1rem;
        margin-bottom: 1.5rem;
        background: #fff;
        padding: 1rem;
        border-radius: 0.75rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .btn-pos {
        background-color: #f0fdf4;
        color: #15803d;
        border: 1px solid #bbf7d0;
        padding: 2px 8px;
        border-radius: 99px;
        font-size: 11px;
        margin-right: 4px;
        margin-top: 4px;
        transition: 0.2s;
        cursor: pointer;
      }
      .btn-neg {
        background-color: #fef2f2;
        color: #b91c1c;
        border: 1px solid #fecaca;
        padding: 2px 8px;
        border-radius: 99px;
        font-size: 11px;
        margin-right: 4px;
        margin-top: 4px;
        transition: 0.2s;
        cursor: pointer;
      }
      .btn-pos:hover {
        background-color: #dcfce7;
        transform: translateY(-1px);
      }
      .btn-neg:hover {
        background-color: #fee2e2;
        transform: translateY(-1px);
      }
      .checkmark {
        color: #10b981;
        font-weight: bold;
        margin-left: auto;
        font-size: 14px;
      }
      .loading-overlay {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      .instruction-box {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        color: #1e40af;
        padding: 10px;
        border-radius: 12px;
        font-size: 12px;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body class="bg-slate-50 min-h-screen font-sans text-slate-900">
    <div id="loading" class="loading-overlay hidden flex-col">
      <div
        class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-900 mb-4"
      ></div>
      <p class="font-bold text-blue-900">åŒæ­¥é›²ç«¯è³‡æ–™ä¸­...</p>
    </div>

    <nav class="bg-blue-900 text-white shadow-xl p-4 sticky top-0 z-50">
      <div class="container mx-auto flex justify-between items-center">
        <div>
          <h1 class="text-xl font-bold">2026 æ·¡æ±ŸåŒ–æç ”è¨æœƒ</h1>
          <p class="text-xs opacity-70">2026/01/13 | è‡ªå‹•å½™æ•´è©•åˆ†åŠ©ç†</p>
        </div>
        <div class="flex gap-2">
          <button
            onclick="showSection('publicResults')"
            class="text-xs bg-green-600 px-4 py-2 rounded-full"
          >
            å³æ™‚æ’è¡Œæ¦œ
          </button>

          <button onclick="showSection('studentQuery')" class="text-xs bg-orange-600 px-4 py-2 rounded-full">
            å­¸ç”ŸæŸ¥åˆ†
          </button>


          <button
            onclick="showSection('loginSection')"
            class="text-xs bg-blue-700 px-4 py-2 rounded-full"
          >
            è©•å¯©å…¥å£
          </button>
          <button
            onclick="enterAdmin()"
            class="text-xs bg-red-700 px-4 py-2 rounded-full"
          >
            ç®¡ç†å¾Œå°
          </button>
        </div>
      </div>
    </nav>

    <main class="container mx-auto p-4 max-w-6xl">
      <section id="publicResults" class="hidden space-y-6">
        <h2 class="text-3xl font-black text-center text-blue-900 my-8 italic">
          å„å ´åœ°å³æ™‚æˆç¸¾çœ‹æ¿ (è‡ªå‹•æ›´æ–°)
        </h2>
        <div
          id="publicRankContainer"
          class="grid grid-cols-1 md:grid-cols-2 gap-8"
        ></div>
      </section>

      <section id="studentQuery" class="hidden max-w-md mx-auto bg-white p-10 mt-12 rounded-3xl shadow-2xl border">
        <h2 class="text-2xl font-black mb-6 text-center text-slate-800">æˆç¸¾èˆ‡è©•èªæŸ¥è©¢</h2>
        <div class="space-y-4">
          <input type="text" id="querySid" class="w-full p-3 border-2 rounded-xl outline-none focus:border-orange-500" placeholder="è«‹è¼¸å…¥å­¸è™Ÿ (å¦‚: 410...)">
          <button onclick="fetchStudentResult()" class="w-full bg-orange-600 text-white py-4 rounded-xl font-bold shadow-lg">æœå°‹æˆ‘çš„ç´€éŒ„</button>
        </div>
  
        <div id="queryResult" class="mt-8 hidden space-y-4">
          <div class="p-4 bg-orange-50 rounded-2xl border border-orange-100">
            <p class="text-xs text-orange-800 font-bold">ç¸½å¹³å‡åˆ†æ•¸</p>
            <p id="resAvg" class="text-5xl font-black text-orange-600">--</p>
          </div>
          <div id="resDetails" class="space-y-3">
            </div>
        </div>
      </section>


      <section id="loginSection" class="hidden max-w-md mx-auto bg-white p-10 mt-12 rounded-3xl shadow-2xl border">
        <h2 class="text-2xl font-black mb-8 text-center text-slate-800">è©•å¯©ç™»å…¥</h2>
        <div class="space-y-6">
          <input
            type="password"
            id="jPassword"
            class="w-full p-4 border-2 rounded-2xl outline-none focus:border-blue-600 text-center text-2xl tracking-widest"
            placeholder="è«‹è¼¸å…¥è©•å¯©å°ˆå±¬å¯†ç¢¼"
          />
          <button
            onclick="judgeLogin()"
            class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition"
          >
            é©—è­‰å¯†ç¢¼ä¸¦ç™»å…¥
          </button>
        </div>
      </section>

      <section id="judgeDashboard" class="hidden space-y-6">
        <div class="flex justify-between items-center border-b pb-4">
          <h2 id="displayVenue" class="text-2xl font-black text-blue-900">
            å ´åœ°åå–®
          </h2>
          <div class="text-right">
            <p id="displayRoom" class="text-slate-500 font-bold text-sm">
              æ•™å®¤ï¼š--
            </p>
            <p id="displayJudge" class="text-xs text-slate-400 font-bold">
              è©•å¯©ï¼š--
            </p>
          </div>
        </div>
        <div
          id="studentListContainer"
          class="bg-white rounded-2xl shadow-md border overflow-hidden"
        ></div>
      </section>

      <section
        id="scoreSection"
        class="hidden max-w-4xl mx-auto bg-white p-8 rounded-3xl shadow-2xl border-t-8 border-blue-900"
      >
        <button
          onclick="showSection('judgeDashboard')"
          class="mb-6 text-blue-600 font-bold hover:underline"
        >
          â† è¿”å›åå–®
        </button>
        <div class="instruction-box">
          <strong>ğŸ’¡ æ“ä½œèªªæ˜ï¼š</strong><br />
          é»é¸ä¸‹æ–¹ç¶­åº¦ä¸­çš„
          <span class="text-green-700 font-bold">ç¶ è‰²æŒ‰éˆ•</span> (æ­£é¢è©•åƒ¹) æˆ–
          <span class="text-red-700 font-bold">ç´…è‰²æŒ‰éˆ•</span>
          (å¾…åŠ å¼·å»ºè­°)ï¼Œè©•èªæœƒè‡ªå‹•å½™æ•´è‡³ä¸‹æ–¹çš„ã€Œå§”å“¡ç¸½çµå»ºè­°ã€ã€‚æ‚¨ä¹Ÿå¯ä»¥åœ¨æ ¼å­å…§è‡ªè¡Œè¼¸å…¥æ–‡å­—ï¼Œç³»çµ±æœƒå³æ™‚åŒæ­¥ã€‚
        </div>

        <div class="mb-8 border-b pb-4 flex justify-between items-end">
          <div>
            <h2 id="scoringName" class="text-3xl font-black text-slate-800">
              è©•åˆ†å°è±¡
            </h2>
            <p id="scoringTitle" class="text-slate-500 text-sm mt-1 italic"></p>
          </div>
          <p id="scoringAdvisor" class="text-blue-700 text-xs font-bold"></p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
          <div class="space-y-4">
            <h3 class="font-bold text-blue-700 border-b pb-2">
              A. å°ˆæ¥­æ€§è©•åˆ† (70%)
            </h3>
            <div class="dimension-card">
              <label class="block text-xs font-bold text-slate-500 mb-1"
                >å ±å‘Šå…§å®¹ (1-5)</label
              >
              <div class="flex gap-2">
                <input
                  type="text"
                  id="r_content"
                  oninput="syncToOverall()"
                  placeholder="[æœ¬é …è©•èª]å¯è¼¸å…¥æ–‡å­—,è‡ªå‹•å½™æ•´ä¸­..."
                  class="flex-1 text-xs border-b outline-none"
                />
              </div>
              <div class="flex flex-wrap mt-2">
                <button
                  onclick="appendReason('r_content','æ¶æ§‹åš´è¬¹')"
                  class="btn-pos"
                >
                  æ¶æ§‹åš´è¬¹
                </button>
                <button
                  onclick="appendReason('r_content','ç›®æ¨™æ˜ç¢º')"
                  class="btn-pos"
                >
                  ç›®æ¨™æ˜ç¢º
                </button>
                <button
                  onclick="appendReason('r_content','å…§å®¹ç©ºæ³›')"
                  class="btn-neg"
                >
                  å…§å®¹ç©ºæ³›
                </button>
                <button
                  onclick="appendReason('r_content','æ•¸æ“šæ··äº‚')"
                  class="btn-neg"
                >
                  æ•¸æ“šæ··äº‚
                </button>
              </div>
            </div>

            <div class="dimension-card">
              <label class="block text-xs font-bold text-slate-500 mb-1"
                >å ±å‘Šæµæš¢åº¦ (1-5)</label
              >
              <div class="flex gap-2">
                <input
                  type="text"
                  id="r_fluency"
                  oninput="syncToOverall()"
                  placeholder="[æœ¬é …è©•èª]å¯è¼¸å…¥æ–‡å­—,è‡ªå‹•å½™æ•´ä¸­..."
                  class="flex-1 text-xs border-b outline-none"
                />
              </div>
              <div class="flex flex-wrap mt-2">
                <button
                  onclick="appendReason('r_fluency','å°é¢¨ç©©å¥')"
                  class="btn-pos"
                >
                  å°é¢¨ç©©å¥
                </button>
                <button
                  onclick="appendReason('r_fluency','è¡¨é”æµåˆ©')"
                  class="btn-pos"
                >
                  è¡¨é”æµåˆ©
                </button>
                <button
                  onclick="appendReason('r_fluency','éåº¦å”¸ç¨¿')"
                  class="btn-neg"
                >
                  éåº¦å”¸ç¨¿
                </button>
                <button
                  onclick="appendReason('r_fluency','èªé€Ÿéå¿«')"
                  class="btn-neg"
                >
                  èªé€Ÿéå¿«
                </button>
              </div>
            </div>

            <div class="dimension-card">
              <label class="block text-xs font-bold text-slate-500 mb-1"
                >æå•æ‡‰ç­” (1-5)</label
              >
              <div class="flex gap-2">
                <input
                  type="text"
                  id="r_qa"
                  oninput="syncToOverall()"
                  placeholder="[æœ¬é …è©•èª]å¯è¼¸å…¥æ–‡å­—,è‡ªå‹•å½™æ•´ä¸­..."
                  class="flex-1 text-xs border-b outline-none"
                />
              </div>
              <div class="flex flex-wrap mt-2">
                <button
                  onclick="appendReason('r_qa','åˆ‡ä¸­è¦é ˜')"
                  class="btn-pos"
                >
                  åˆ‡ä¸­è¦é ˜
                </button>
                <button
                  onclick="appendReason('r_qa','é‚è¼¯åš´å¯†')"
                  class="btn-pos"
                >
                  é‚è¼¯åš´å¯†
                </button>
                <button
                  onclick="appendReason('r_qa','å›è¦†æ¨¡ç³Š')"
                  class="btn-neg"
                >
                  å›è¦†æ¨¡ç³Š
                </button>
                <button
                  onclick="appendReason('r_qa','æ¦‚å¿µéŒ¯èª¤')"
                  class="btn-neg"
                >
                  æ¦‚å¿µéŒ¯èª¤
                </button>
              </div>
            </div>

            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
              <label class="block text-xs font-bold text-blue-800 mb-1"
                >å°ˆæ¥­åŸå§‹åˆ† (0-100)</label
              >
              <input
                type="number"
                id="profRaw"
                class="w-full p-2 text-2xl font-black rounded-lg border-2 outline-none focus:border-blue-500"
                oninput="calcTotal()"
              />
            </div>
          </div>

          <div class="space-y-4">
            <h3 class="font-bold text-green-700 border-b pb-2">
              B. æŠ€è¡“æ€§è©•åˆ† (30%)
            </h3>
            <div class="dimension-card" style="border-left-color: #22c55e">
              <label class="block text-xs font-bold text-slate-500 mb-1"
                >æ™‚é–“æŒæ§ (1-5)</label
              >
              <div class="flex gap-2">
                <input
                  type="text"
                  id="r_time"
                  oninput="syncToOverall()"
                  placeholder="[æœ¬é …è©•èª]å¯è¼¸å…¥æ–‡å­—,è‡ªå‹•å½™æ•´ä¸­..."
                  class="flex-1 text-xs border-b outline-none"
                />
              </div>
              <div class="flex flex-wrap mt-2">
                <button
                  onclick="appendReason('r_time','æŒæ¡ç²¾æº–')"
                  class="btn-pos"
                >
                  æŒæ¡ç²¾æº–
                </button>
                <button
                  onclick="appendReason('r_time','å ±å‘Šè¶…æ™‚')"
                  class="btn-neg"
                >
                  å ±å‘Šè¶…æ™‚
                </button>
              </div>
            </div>

            <div class="dimension-card" style="border-left-color: #22c55e">
              <label class="block text-xs font-bold text-slate-500 mb-1"
                >æœå„€å„€æ…‹ (1-5)</label
              >
              <div class="flex gap-2">
                <input
                  type="text"
                  id="r_outfit"
                  oninput="syncToOverall()"
                  placeholder="[æœ¬é …è©•èª]å¯è¼¸å…¥æ–‡å­—,è‡ªå‹•å½™æ•´ä¸­..."
                  class="flex-1 text-xs border-b outline-none"
                />
              </div>
              <div class="flex flex-wrap mt-2">
                <button
                  onclick="appendReason('r_outfit','å°ˆæ¥­èŠé‡')"
                  class="btn-pos"
                >
                  å°ˆæ¥­èŠé‡
                </button>
                <button
                  onclick="appendReason('r_outfit','å»ºè­°æ­£å¼')"
                  class="btn-neg"
                >
                  å»ºè­°æ­£å¼
                </button>
              </div>
            </div>

            <div class="bg-green-50 p-4 rounded-xl border border-green-100">
              <label class="block text-xs font-bold text-green-800 mb-1"
                >æŠ€è¡“åŸå§‹åˆ† (0-100)</label
              >
              <input
                type="number"
                id="techRaw"
                class="w-full p-2 text-2xl font-black rounded-lg border-2 outline-none focus:border-green-500"
                oninput="calcTotal()"
              />
            </div>

            <div class="p-4 bg-slate-100 rounded-xl border mt-8">
              <label class="block text-sm font-bold text-blue-900 mb-2"
                >â— å§”å“¡ç¸½çµå»ºè­° (è‡ªå‹•å½™æ•´)ï¼š</label
              >
              <textarea
                id="judgeComment"
                class="w-full p-3 text-sm border-2 rounded-xl h-40 outline-none focus:border-blue-500 shadow-inner leading-relaxed"
                placeholder="å½™æ•´ä¸­..."
              ></textarea>
            </div>
          </div>
        </div>

        <div
          class="mt-8 flex justify-between items-center bg-slate-900 text-white p-8 rounded-3xl shadow-2xl"
        >
          <div>
            åŠ æ¬Šç¸½æˆç¸¾ï¼š<span
              id="finalScoreDisplay"
              class="text-6xl font-black text-yellow-400"
              >0</span
            >åˆ†
          </div>
          <button
                onclick="deleteGradingFromCloud()"
                class="bg-red-600 px-8 py-4 rounded-2xl font-bold text-xl hover:bg-red-700 transition shadow-lg"
              >
                åˆªé™¤ç´€éŒ„
              </button>

          <button
            onclick="submitGradingToCloud()"
            class="bg-blue-600 px-16 py-4 rounded-2xl font-black text-2xl hover:bg-white hover:text-blue-900 transition shadow-xl"
          >
            é€å‡ºè©•åˆ†
          </button>
        </div>
      </section>

      <section
        id="adminDashboard"
        class="hidden bg-white rounded-3xl shadow-xl p-8"
      >
        <div class="flex gap-6 border-b-2 mb-8">
          <button
            onclick="toggleAdminTab('venue')"
            id="tab-btn-venue"
            class="admin-tab active pb-4 px-2"
          >
            å ´åœ°èˆ‡å§”å“¡
          </button>
          <button
            onclick="toggleAdminTab('student')"
            id="tab-btn-student"
            class="admin-tab pb-4 px-2"
          >
            åå–®åŒ¯å…¥ (Excel)
          </button>
        </div>
        <div id="admin-venue" class="admin-content space-y-6">
          <div
            id="venueConfigContainer"
            class="grid grid-cols-1 md:grid-cols-2 gap-6"
          ></div>
          <div class="flex gap-4">
            <button
              onclick="saveAdminConfig()"
              class="flex-1 bg-blue-900 text-white py-3 rounded-xl font-bold"
            >
              å„²å­˜å ´åœ°é…ç½®
            </button>
            <button
              onclick="exportAllScores()"
              class="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold"
            >
              ğŸ“Š åŒ¯å‡ºæˆç¸¾ Excel
            </button>
          </div>
        </div>
        <div id="admin-student" class="admin-content hidden space-y-6">
          <div
            class="p-6 border-2 border-dashed rounded-2xl bg-slate-50 flex justify-between items-center"
          >
            <input
              type="file"
              onchange="handleExcelImport(this)"
              class="text-sm"
            />
            <button
              onclick="clearStudentsCloud()"
              class="bg-red-50 text-red-600 px-6 py-2 rounded-xl border border-red-200"
            >
              æ¸…ç©ºåå–®
            </button>
          </div>

          <div class="overflow-x-auto">
            <table id="adminStudentTable" class="w-full border-collapse block md:table">
            </table>
          </div>
        </div>
      </section>
    </main>

    <script>
      // Firebase é…ç½®
      const firebaseConfig = {
        apiKey: "AIzaSyBNa3SAk7yqzRjPyYuKZyLIJesm6M7c57w",
        authDomain: "cme-seminar2026.firebaseapp.com",
        projectId: "cme-seminar2026",
        storageBucket: "cme-seminar2026.firebasestorage.app",
        messagingSenderId: "61658181836",
        appId: "1:61658181836:web:6c8d964c66512575dc9269",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      let students = [];
      let scores = [];
      let venueConfig = {
        A1: { room: "", judges: ["", ""] },
        A2: { room: "", judges: ["", ""] },
        B1: { room: "", judges: ["", ""] },
        B2: { room: "", judges: ["", ""] },
      };
      const venues = ["A1", "A2", "B1", "B2"];
      let currentUser = null;
      let activeStudent = null;

window.onload = async () => {
  toggleLoading(true); // é–‹å•Ÿé®ç½©
  
  try {
    // 1. åˆå§‹åŒ–å¾Œå°ä»‹é¢å…§å®¹
    const container = document.getElementById("venueConfigContainer");
    container.innerHTML = venues.map(v => `
      <div class="p-5 border rounded-2xl bg-slate-50">
        <div class="flex gap-2 mb-4">
          <span class="bg-blue-900 text-white px-3 py-1 rounded font-bold">${v}</span>
          <input type="text" id="vRoom_${v}" placeholder="å ´åœ°åç¨±" class="flex-1 border-b bg-transparent outline-none">
        </div>
        <div class="grid grid-cols-2 gap-2">
          <input type="text" id="vJudge_${v}_1" placeholder="è©•å¯©1" class="p-2 border rounded text-xs">
          <input type="text" id="vPwd_${v}_1" placeholder="å¯†ç¢¼1" class="p-2 border rounded text-xs">
          <input type="text" id="vJudge_${v}_2" placeholder="è©•å¯©2" class="p-2 border rounded text-xs">
          <input type="text" id="vPwd_${v}_2" placeholder="å¯†ç¢¼2" class="p-2 border rounded text-xs">
        </div>
      </div>`).join("");

    // 2. å¾ Firebase è®€å–è¨­å®š
    const configDoc = await db.collection("Settings").doc("VenueConfig").get();
    if (configDoc.exists) {
      venueConfig = configDoc.data();
      venues.forEach((v) => {
        if (venueConfig[v]) {
          document.getElementById(`vRoom_${v}`).value = venueConfig[v].room || "";
          document.getElementById(`vJudge_${v}_1`).value = venueConfig[v].judges[0] || "";
          document.getElementById(`vJudge_${v}_2`).value = venueConfig[v].judges[1] || "";
          if (venueConfig[v].passwords) {
            document.getElementById(`vPwd_${v}_1`).value = venueConfig[v].passwords[0] || "";
            document.getElementById(`vPwd_${v}_2`).value = venueConfig[v].passwords[1] || "";
          }
        }
      });
    }
    updateVenueDropdown();

    // 3. è¨­å®šå³æ™‚ç›£è½
    db.collection("Students").onSnapshot(snap => {
      students = snap.docs.map(doc => doc.data());
      renderAdminList();
      if (currentUser) renderStudentList();
    });

    db.collection("Scores").onSnapshot(snap => {
      scores = snap.docs.map(doc => doc.data());
      renderPublicResults();
      if (currentUser) renderStudentList();
    });

  } catch (error) {
    console.error("åˆå§‹åŒ–å‡ºéŒ¯:", error);
    alert("é›²ç«¯è³‡æ–™åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥é€£ç·š");
  } finally {
    // ç„¡è«–æˆåŠŸæˆ–å‡ºéŒ¯ï¼Œæœ€å¾Œä¸€å®šåŸ·è¡Œ
    toggleLoading(false); 
    showSection("publicResults");
  }
};


      // å¤šæ¬„ä½å³æ™‚æ’è¡Œæ¦œé‚è¼¯
      function renderPublicResults() {
        const container = document.getElementById("publicRankContainer");
        container.innerHTML = venues
          .map((v) => {
            const room = venueConfig[v]?.room || "æœªè¨­å®š";
            const judges = venueConfig[v]?.judges || ["è©•å¯©1", "è©•å¯©2"];
            const vScores = scores.filter((s) => s.venue === v);

            const grouped = {};
            vScores.forEach((s) => {
              if (!grouped[s.studentId])
                grouped[s.studentId] = {
                  name: s.studentName,
                  j1: "--",
                  j2: "--",
                  avg: 0,
                  sum: 0,
                  count: 0,
                };
              if (s.judge === judges[0]) grouped[s.studentId].j1 = s.total;
              else if (s.judge === judges[1]) grouped[s.studentId].j2 = s.total;
              grouped[s.studentId].sum += s.total;
              grouped[s.studentId].count++;
              grouped[s.studentId].avg = Math.round(
                grouped[s.studentId].sum / grouped[s.studentId].count
              );
            });
            const rank = Object.values(grouped).sort((a, b) => b.avg - a.avg);

            return `
            <div class="bg-white p-6 rounded-3xl shadow border-t-8 border-blue-900">
              <h3 class="font-black text-xl mb-4 border-b pb-2 flex justify-between">
                <span>${v} å ´åœ° (${room})</span>
                <span class="text-xs text-blue-500 animate-pulse">Live</span>
              </h3>
              <div class="space-y-3">
                <div class="grid grid-cols-5 text-[10px] text-slate-400 font-bold px-2">
                  <div class="col-span-2">å­¸ç”Ÿå§“å</div>
                  <div class="text-center">è©•å¯©1</div>
                  <div class="text-center">è©•å¯©2</div>
                  <div class="text-right">å¹³å‡</div>
                </div>
                ${
                  rank.length
                    ? rank
                        .map(
                          (r, i) => `
                  <div class="grid grid-cols-5 items-center text-sm p-2 ${
                    i === 0 ? "bg-yellow-50 rounded-lg" : ""
                  }">
                    <div class="col-span-2 font-bold text-slate-700">${
                      i + 1
                    }. ${r.name}</div>
                    <div class="text-center font-mono text-xs text-slate-400">${
                      r.j1
                    }</div>
                    <div class="text-center font-mono text-xs text-slate-400">${
                      r.j2
                    }</div>
                    <div class="text-right font-black ${
                      i === 0 ? "text-blue-700" : "text-slate-600"
                    }">${r.avg}</div>
                  </div>`
                        )
                        .join("")
                    : '<p class="text-xs text-slate-300 text-center py-4">â³ ç­‰å¾…è©•åˆ†ä¸­...</p>'
                }
              </div>
            </div>`;
          })
          .join("");
      }

// é–‹å•Ÿå­¸ç”ŸæŸ¥è©¢é é¢
async function fetchStudentResult() {
  const sid = document.getElementById("querySid").value.trim();
  if (!sid) return alert("è«‹è¼¸å…¥å­¸è™Ÿ");

  toggleLoading(true);
  try {
    // å¾ Scores é›†åˆä¸­æŠ“å–è©²å­¸è™Ÿçš„æ‰€æœ‰è©•åˆ†è³‡æ–™
    const snap = await db.collection("Scores").where("studentId", "==", sid).get();
    
    if (snap.empty) {
      alert("å°šæœªæœ‰è©•åˆ†ç´€éŒ„ï¼Œè«‹ç¢ºèªå­¸è™Ÿæ˜¯å¦æ­£ç¢ºæˆ–ç¨å¾Œå†è©¦ã€‚");
      document.getElementById("queryResult").classList.add("hidden");
    } else {
      let totalSum = 0;
      let html = "";
      
      snap.forEach(doc => {
        const d = doc.data();
        totalSum += d.total;
        html += `
          <div class="p-4 bg-white border rounded-xl shadow-sm text-sm">
            <p class="font-bold text-blue-900 border-b pb-1 mb-2">è©•å¯©å»ºè­°ï¼š</p>
            <p class="whitespace-pre-line text-slate-600 italic">${d.feedback_json.summary || "ç„¡å…·é«”è©•èª"}</p>
          </div>`;
      });

      document.getElementById("resAvg").innerText = Math.round(totalSum / snap.size);
      document.getElementById("resDetails").innerHTML = html;
      document.getElementById("queryResult").classList.remove("hidden");
    }
  } catch (e) {
    alert("æŸ¥è©¢å‡ºéŒ¯");
  } finally {
    toggleLoading(false);
  }
}




      // é–‹å•Ÿè©•åˆ†é é¢ (å«å›é¡¯é‚è¼¯)
      function openScoring(sid) {
        activeStudent = students.find((s) => s.id === sid);
        document.getElementById("scoringName").innerText = activeStudent.name;
        document.getElementById("scoringTitle").innerText =
          activeStudent.title || "";
        document.getElementById("scoringAdvisor").innerText = `æŒ‡å°æ•™æˆï¼š${
          activeStudent.advisor || "--"
        }`;

        const history = scores.find(
          (sc) => sc.studentId === sid && sc.judge === currentUser.name
        );
        if (history) {
          document.getElementById("profRaw").value = history.profRaw || "";
          document.getElementById("techRaw").value = history.techRaw || "";
          document.getElementById("judgeComment").value =
            history.feedback_json?.summary || "";
          document.getElementById("finalScoreDisplay").innerText =
            history.total || "0";
          if (history.details) {
            ["content", "fluency", "qa", "time", "outfit"].forEach((key) => {
              const d = history.details[key];
              document.getElementById(`r_${key}`).value = d.reason || "";
            });
          }
        } else {
          // é‡ç½®
          [
            "profRaw",
            "techRaw",
            "judgeComment",
            "r_content",
            "r_fluency",
            "r_qa",
            "r_time",
            "r_outfit",
          ].forEach((id) => (document.getElementById(id).value = ""));
          ["v_content", "v_fluency", "v_qa", "v_time", "v_outfit"].forEach(
            (id) => (document.getElementById(id).value = "3")
          );
          document.getElementById("finalScoreDisplay").innerText = "0";
        }
        showSection("scoreSection");
      }

      async function deleteGradingFromCloud() {
        // 1. å®‰å…¨ç¢ºèª
        if (!confirm(`ç¢ºå®šè¦å®Œå…¨åˆªé™¤å°ã€Œ${activeStudent.name}ã€çš„è©•åˆ†ç´€éŒ„å—ï¼Ÿ\nåˆªé™¤å¾Œè©²ç”Ÿå°‡æ¢å¾©ç‚ºã€Œå°šæœªè©•åˆ†ã€ç‹€æ…‹ã€‚`)) return;

        toggleLoading(true);
        const docId = `${currentUser.name}_${activeStudent.id}`;

        try {
          // 2. å¾ Firebase åˆªé™¤æ–‡ä»¶
          await db.collection("Scores").doc(docId).delete();
    
          alert("ç´€éŒ„å·²æˆåŠŸåˆªé™¤");
    
          // 3. é‡ç½®ç›®å‰çš„è¼¸å…¥æ¬„ä½
          [
            "profRaw", "techRaw", "judgeComment",
            "r_content", "r_fluency", "r_qa", "r_time", "r_outfit"
          ].forEach(id => document.getElementById(id).value = "");
    
          ["v_content", "v_fluency", "v_qa", "v_time", "v_outfit"].forEach(
            id => document.getElementById(id).value = "3"
          );
          document.getElementById("finalScoreDisplay").innerText = "0";

          // 4. è¿”å›å ´åœ°æ¸…å–®
          showSection("judgeDashboard");
    
        } catch (e) {
          console.error(e);
          alert("åˆªé™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š");
        } finally {
          toggleLoading(false);
        }
      }



      async function submitGradingToCloud() {
        const p = document.getElementById("profRaw").value;
        const t = document.getElementById("techRaw").value;
        if (p === "" || t === "") return alert("è«‹è¼¸å…¥ 0-100 åˆ†æ•¸");
        toggleLoading(true);
        const docId = `${currentUser.name}_${activeStudent.id}`;
        try {
          await db
            .collection("Scores")
            .doc(docId)
            .set({
              judge: currentUser.name,
              venue: currentUser.venue,
              studentId: activeStudent.id,
              studentName: activeStudent.name,
              total: parseInt(
                document.getElementById("finalScoreDisplay").innerText
              ),
              profRaw: parseInt(p),
              techRaw: parseInt(t),

              // ä¿®æ”¹å¾Œçš„ç´°ç¯€å„²å­˜é‚è¼¯ (æ‹¿æ‰ score æ¬„ä½)
              details: {
                content: { reason: document.getElementById("r_content").value },
                fluency: { reason: document.getElementById("r_fluency").value },
                qa:      { reason: document.getElementById("r_qa").value },
                time:    { reason: document.getElementById("r_time").value },
                outfit:  { reason: document.getElementById("r_outfit").value },
              },

              feedback_json: {
                summary: document.getElementById("judgeComment").value,
              },
              timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            });
          alert("è©•åˆ†æˆåŠŸï¼");
          showSection("judgeDashboard");
        } catch (e) {
          alert("å„²å­˜å¤±æ•—");
        }
        toggleLoading(false);
      }

      function syncToOverall() {
        const map = [
          { id: "r_content", label: "å…§å®¹" },
          { id: "r_fluency", label: "æµæš¢" },
          { id: "r_qa", label: "æ‡‰ç­”" },
          { id: "r_time", label: "æ™‚é–“" },
          { id: "r_outfit", label: "æœå„€" },
        ];
        document.getElementById("judgeComment").value = map
          .map((item) => {
            const val = document.getElementById(item.id).value.trim();
            return val ? `ã€${item.label}ã€‘${val}` : "";
          })
          .filter((s) => s !== "")
          .join("\n");
      }

      function calcTotal() {
        const p = parseFloat(document.getElementById("profRaw").value) || 0;
        const t = parseFloat(document.getElementById("techRaw").value) || 0;
        document.getElementById("finalScoreDisplay").innerText = Math.round(
          p * 0.7 + t * 0.3
        );
      }

      function appendReason(id, text) {
        const el = document.getElementById(id);
        if (!el.value.includes(text)) el.value += (el.value ? "ã€" : "") + text;
        syncToOverall();
      }

      // ç®¡ç†èˆ‡å·¥å…·
      function judgeLogin() {
        const p = document.getElementById("jPassword").value.trim();
        if (!p) return alert("è«‹è¼¸å…¥å¯†ç¢¼");

        let foundUser = null;

        // éæ­·æ‰€æœ‰å ´åœ° (A1, A2, B1, B2)
        for (let v of venues) {
          const config = venueConfig[v];
          if (config && config.passwords) {
            // æª¢æŸ¥è©²å ´åœ°çš„å…©çµ„å¯†ç¢¼
            const pwdIndex = config.passwords.indexOf(p);
      
            if (pwdIndex !== -1) {
              // æ‰¾åˆ°äº†ï¼å°æ‡‰ index å–å¾—è©•å¯©å§“å
              foundUser = {
                name: config.judges[pwdIndex],
                venue: v,
                room: config.room
              };
              break; // è·³å‡ºè¿´åœˆ
            }
          }
        }

        if (foundUser) {
          if (!foundUser.name) {
            return alert("æ­¤å¯†ç¢¼å·²å»ºç«‹ï¼Œä½†å°šæœªè¨­å®šè©•å¯©å§“åï¼Œè«‹è¯ç¹«ç®¡ç†å“¡ã€‚");
          }
    
          // ç™»å…¥æˆåŠŸï¼Œè¨­å®šç•¶å‰ä½¿ç”¨è€…
          currentUser = foundUser;
    
          // æ›´æ–°ä»‹é¢é¡¯ç¤º
          document.getElementById("displayVenue").innerText = `${foundUser.venue} å ´åœ°æ¸…å–®`;
          document.getElementById("displayRoom").innerText = `æ•™å®¤ï¼š${foundUser.room}`;
          document.getElementById("displayJudge").innerText = `è©•å¯©ï¼š${foundUser.name}`;
    
          showSection("judgeDashboard");
          renderStudentList();
          
          // æ¸…ç©ºå¯†ç¢¼æ¡†ä»¥ä¿å®‰å…¨
          document.getElementById("jPassword").value = "";
        } else {
          alert("å¯†ç¢¼éŒ¯èª¤æˆ–ä¸å­˜åœ¨ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚");
        }
      }


      function renderStudentList() {
        const container = document.getElementById("studentListContainer");
        const filtered = students.filter((s) => s.venue === currentUser.venue);
        container.innerHTML = filtered
          .map((s) => {
            const isDone = scores.some(
              (sc) => sc.studentId === s.id && sc.judge === currentUser.name
            );
            return `<div onclick="openScoring('${
              s.id
            }')" class="flex items-center p-4 border-b hover:bg-slate-50 cursor-pointer">
              <div class="flex-1">
                <p class="text-[10px] font-mono text-slate-400">${s.id}</p>
                <h3 class="font-bold text-lg">${s.name}</h3>
                <p class="text-xs text-slate-500 truncate">${s.title || ""}</p>
              </div>
              ${
                isDone
                  ? '<span class="checkmark">âœ” å·²å®Œæˆ</span>'
                  : '<span class="text-xs text-slate-300">å°šæœªè©•åˆ†</span>'
              }
            </div>`;
          })
          .join("");
      }

      async function saveAdminConfig() {
        venues.forEach((v) => {
          venueConfig[v] = {
            room: document.getElementById(`vRoom_${v}`).value,
            judges: [
              document.getElementById(`vJudge_${v}_1`).value,
              document.getElementById(`vJudge_${v}_2`).value,
            ],
            passwords: [ // å¢åŠ å„²å­˜å¯†ç¢¼é™£åˆ—
              document.getElementById(`vPwd_${v}_1`).value,
              document.getElementById(`vPwd_${v}_2`).value,
            ],
          };
        });
        await db.collection("Settings").doc("VenueConfig").set(venueConfig);
        alert("é›²ç«¯åŒæ­¥æˆåŠŸ");
        updateVenueDropdown();
        renderPublicResults();
      }

      function exportAllScores() {
        const data = scores.map((s) => ({
          å ´åœ°: s.venue,
          è©•å¯©: s.judge,
          å­¸ç”Ÿ: s.studentName,
          å­¸è™Ÿ: s.studentId,
          å°ˆæ¥­åˆ†: s.profRaw,
          æŠ€è¡“åˆ†: s.techRaw,
          åŠ æ¬Šç¸½åˆ†: s.total,
          è©•èª: s.feedback_json.summary,
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Scores");
        XLSX.writeFile(
          wb,
          `æ·¡æ±ŸåŒ–æç ”è¨æœƒæˆç¸¾_${new Date().toLocaleDateString()}.xlsx`
        );
      }

      async function handleExcelImport(input) {
        const reader = new FileReader();
        reader.onload = async (e) => {
          const data = XLSX.read(new Uint8Array(e.target.result), {
            type: "array",
          });
          const json = XLSX.utils.sheet_to_json(
            data.Sheets[data.SheetNames[0]],
            { header: 1 }
          );
          const batch = db.batch();
          json.slice(1).forEach((r) => {
            if (r[0])
              batch.set(db.collection("Students").doc(String(r[0])), {
                id: String(r[0]),
                name: r[1],
                advisor: r[2],
                title: r[3],
                venue: r[4] ? String(r[4]).toUpperCase().trim() : "æœªåˆ†é…",
              });
          });
          await batch.commit();
          alert("åŒ¯å…¥æˆåŠŸ");
        };
        reader.readAsArrayBuffer(input.files[0]);
      }

      function enterAdmin() {
        if (prompt("è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼,æç¤ºt???2??4") === "tedx2614")
          showSection("adminDashboard");
      }
      function clearStudentsCloud() {
        if (confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ"))
          db.collection("Students")
            .get()
            .then((qs) => {
              const b = db.batch();
              qs.forEach((d) => b.delete(d.ref));
              b.commit();
            });
      }
      function toggleLoading(s) {
        document.getElementById("loading").classList.toggle("hidden", !s);
      }
      function showSection(id) {
        document
          .querySelectorAll("main > section")
          .forEach((s) => s.classList.add("hidden"));
        document.getElementById(id).classList.remove("hidden");
        window.scrollTo(0, 0);
      }
      function toggleAdminTab(t) {
        document
          .querySelectorAll(".admin-content")
          .forEach((c) => c.classList.add("hidden"));
        document
          .querySelectorAll(".admin-tab")
          .forEach((b) => b.classList.remove("active"));
        document.getElementById(`admin-${t}`).classList.remove("hidden");
        document.getElementById(`tab-btn-${t}`).classList.add("active");
      }
      function updateVenueDropdown() {
        document.getElementById("jVenue").innerHTML = venues
          .map(
            (v) =>
              `<option value="${v}">${v} å ´åœ° (${
                venueConfig[v].room || ""
              })</option>`
          )
          .join("");
      }


      function renderAdminList() {
        const tableBody = document.getElementById("adminStudentTable");

        // 1. è¡¨é ­ï¼šåœ¨æ‰‹æ©Ÿç«¯éš±è— (hidden)ï¼Œä¸­è¦–çª—ä»¥ä¸Šé¡¯ç¤º (md:table-header-group)
        const header = `
          <thead class="hidden md:table-header-group bg-slate-100 font-bold">
            <tr>
              <td class="p-3 border">å­¸è™Ÿ (ID)</td>
              <td class="p-3 border">å§“å</td>
              <td class="p-3 border">æŒ‡å°æ•™æˆ</td>
              <td class="p-3 border">è«–æ–‡é¡Œç›®</td>
              <td class="p-3 border text-center">å ´åœ°</td>
            </tr>
          </thead>`;

        // 2. è³‡æ–™åˆ—ï¼šæ‰‹æ©Ÿç«¯è½‰ç‚ºå¡ç‰‡ (block + shadow)ï¼Œä¸­è¦–çª—ä»¥ä¸Šæ¢å¾©ç‚ºè¡¨æ ¼åˆ— (md:table-row)
        const rows = students.map((s) => `
          <tr class="block md:table-row mb-4 md:mb-0 bg-white border md:border-b shadow-sm md:shadow-none rounded-xl md:rounded-none p-4 md:p-0">
      
            <td data-label="å­¸è™Ÿ" class="block md:table-cell p-1 md:p-3 text-xs font-mono text-slate-500 md:text-slate-900 
              before:content-[attr(data-label)] before:md:hidden before:font-bold before:mr-2 before:text-slate-400">
              ${s.id}
            </td>
      
            <td data-label="å§“å" class="block md:table-cell p-1 md:p-3 font-bold text-lg md:text-base
              before:content-[attr(data-label)] before:md:hidden before:font-bold before:mr-2 before:text-slate-400">
              ${s.name}
            </td>
      
            <td data-label="æŒ‡å°æ•™æˆ" class="block md:table-cell p-1 md:p-3 text-sm
              before:content-[attr(data-label)] before:md:hidden before:font-bold before:mr-2 before:text-slate-400">
              ${s.advisor || "--"}
            </td>
      
            <td data-label="è«–æ–‡é¡Œç›®" class="block md:table-cell p-1 md:p-3 text-xs text-slate-600
              before:content-[attr(data-label)] before:md:hidden before:font-bold before:mr-2 before:text-slate-400">
              ${s.title || "--"}
            </td>
      
            <td data-label="å ´åœ°" class="block md:table-cell p-1 md:p-3 text-left md:text-center
              before:content-[attr(data-label)] before:md:hidden before:font-bold before:mr-2 before:text-slate-400">
              <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-bold inline-block mt-1 md:mt-0">
                ${s.venue}
              </span>
            </td>
      
          </tr>
        `).join("");

        tableBody.innerHTML = header + `<tbody class="block md:table-row-group">${rows}</tbody>`;
      }
    </script>
  </body>
</html>
